name: CI
permissions:
    contents: read

on:
    push:
        branches: [main]
    pull_request:
    workflow_dispatch:

jobs:
    test:
        runs-on: ubuntu-latest

        services:
            postgres:
                image: postgres:16
                env:
                    POSTGRES_USER: ouroboros
                    POSTGRES_PASSWORD: ouroboros
                    POSTGRES_DB: ouroboros
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Set up Python 3.14
              uses: actions/setup-python@v6
              with:
                  python-version: "3.14"

            - name: Install uv (Python package manager)
              uses: astral-sh/setup-uv@v7
              with:
                  version: "latest"

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install just
              uses: extractions/setup-just@v3

            - name: Wait for PostgreSQL
              run: |
                  echo "Waiting for PostgreSQL to be ready..."
                  sleep 10

            - name: Install Python dependencies
              run: uv sync --all-packages --group ci --frozen

            - name: Install frontend dependencies
              run: cd frontend && bun install

            - name: Install Playwright browsers
              run: cd frontend && bunx playwright install --with-deps

            - name: Cache uv dependencies
              uses: actions/cache@v5
              with:
                  path: |
                      ~/.cache/uv
                      .venv
                  key: ${{ runner.os }}-uv-${{ hashFiles('**/uv.lock', '**/.python-version') }}
                  restore-keys: |
                      ${{ runner.os }}-uv-

            - name: Cache Bun dependencies
              uses: actions/cache@v5
              with:
                  path: ~/.bun/install/cache
                  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
                  restore-keys: |
                      ${{ runner.os }}-bun-

            - name: Run CI checks
              env:
                  DATABASE_URL: postgresql://ouroboros:ouroboros@localhost:5432/ouroboros
                  POSTGRES_HOST: localhost
                  POSTGRES_PORT: 5432
                  POSTGRES_USER: ouroboros
                  POSTGRES_PASSWORD: ouroboros
                  POSTGRES_DB: ouroboros
                  # Legacy environment variables that might be used
                  POSTGRES_SERVER: localhost
                  DB_USER: ouroboros
                  DB_PASSWORD: ouroboros
                  DB_NAME: ouroboros
                  DB_HOST: localhost
                  DB_PORT: 5432
              run: uv run just github-ci-check

            - name: Upload coverage to Codecov
              if: success()
              uses: codecov/codecov-action@v5
              with:
                  files: ./coverage.xml
                  fail_ci_if_error: false
